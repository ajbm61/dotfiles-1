#!/bin/sh

set -e
unset CDPATH
unset IFS
readonly SOURCE="$(readlink -nf "$0")"
readonly SOURCE_PATH="$(dirname "$SOURCE")"

create_home_dir_symlink() {
    target="$1"
    target_basename="$(basename "$target")"

    if test "$target_basename" = "."; then
        continue
    fi

    if test "$target_basename" = ".."; then
        continue
    fi

    if test "$HOME/$target_basename" = "$SOURCE_PATH"; then
        echo >&2 "$0:create_home_dir_symlink() cannot link to self"
        exit 1
    fi

    link_target="./${target#$HOME/}"
    link_name="$HOME/$target_basename"

    if test -L "$link_name" -o ! -e "$link_name"; then
        ln -sfnv "$link_target" "$link_name"
    else
        echo >&2 "=> NOTICE Could not create home directory symlink."
        echo >&2 "          File alreay exists {target: \"$link_target\", name: \"$link_name\"}."
        echo >&2 "          Move the existing file and rerun the install script."
    fi
}

cd "$SOURCE_PATH"
echo "command: cd $SOURCE_PATH"

if test "$1" != "--skip-dependencies"; then
    echo "Installing dependencies..."
    command -v ctags >/dev/null 2>&1 || sudo apt-get install exuberant-ctags
    command -v figlet >/dev/null 2>&1 || sudo apt-get install figlet
    command -v firefox >/dev/null 2>&1 || sudo apt-get install firefox firefox-locale-en
    command -v flake8 >/dev/null 2>&1 || sudo apt-get install python-flake8
    command -v gimp >/dev/null 2>&1 || sudo apt-get install gimp
    command -v git >/dev/null 2>&1 || sudo apt-get install git
    command -v gitk >/dev/null 2>&1 || sudo apt-get install gitk
    command -v gtypist >/dev/null 2>&1 || sudo apt-get install gtypist
    command -v liferea >/dev/null 2>&1 || sudo apt-get install liferea
    command -v netstat >/dev/null 2>&1 || sudo apt-get install net-tools
    command -v tmux >/dev/null 2>&1 || sudo apt-get install tmux
    command -v tree >/dev/null 2>&1 || sudo apt-get install tree
    command -v vim.basic >/dev/null 2>&1 || sudo apt-get install vim
    command -v xclip >/dev/null 2>&1 || sudo apt-get install xclip
    command -v rename >/dev/null 2>&1 || sudo apt-get install rename
    command -v dconf-editor >/dev/null 2>&1 || sudo apt-get install dconf-tools

    # Required for Git interactive.singlekey to work.
    # See https://superuser.com/a/817688.
    dpkg -l | grep libterm-readkey-perl >/dev/null 2>&1 || sudo apt-get install libterm-readkey-perl

    # Fonts.
    dpkg -l | grep fonts-firacode >/dev/null 2>&1 || sudo apt-get install fonts-firacode
    dpkg -l | grep fonts-inconsolata >/dev/null 2>&1 || sudo apt-get install fonts-inconsolata
    dpkg -l | grep ttf-anonymous-pro >/dev/null 2>&1 || sudo apt-get install ttf-anonymous-pro
    # The following fonts need to be manually installed:
    # Hasklig (Source Code Pro font with ligatures) https://github.com/i-tu/Hasklig
    # Monoid (lagature font) https://github.com/larsenwork/monoid

else
    shift
fi

if test "$1" != "--skip-submodules"; then
    echo "Updating dependencies..."
    git submodule update --init --recursive
    git submodule foreach 'git fetch && git merge --ff-only origin/master'
else
    shift
fi

echo "Configuring home directory $HOME symbolic links..."

for file in "$SOURCE_PATH/src/".*; do
    create_home_dir_symlink "$file"
done

for file in "$SOURCE_PATH"/src/*; do
    create_home_dir_symlink "$file"
done

ln -sfv ~/.dotfiles/vendor/paulirish/git-open/git-open ~/bin/git-open
ln -sfv ~/.dotfiles/vendor/php-build/php-build/bin/php-build  ~/bin/php-build

# TODO esnure symlink for ~/.config/nvim -> ../.vim

mkdir -p ~/.rbenv/plugins
touch ~/.rbenv/plugins/ruby-build
rm ~/.rbenv/plugins/ruby-build
ln -sfv ~/.dotfiles/vendor/rbenv/ruby-build ~/.rbenv/plugins/ruby-build

if test -f ~/.dotfiles-private/install; then
    ~/.dotfiles-private/install
fi
